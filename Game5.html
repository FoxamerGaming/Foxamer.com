
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Magic Survival — Mouse Look & Item Pickup Integrated</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<style>
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial}
  #ui-root{position:absolute;inset:0;z-index:9999;pointer-events:auto}
  /* HUD */
  #hud{position:absolute;left:12px;top:12px;color:#fff;width:360px;z-index:10000}
  .label-row{display:flex;justify-content:space-between;font-size:13px}
  .bar-wrap{margin:6px 0;background:rgba(0,0,0,0.55);padding:6px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
  .bar{height:14px;border-radius:8px;background:#222;overflow:hidden}
  .fill{height:100%;transition:width .25s}
  .hp-fill{background:linear-gradient(90deg,#ff6a6a,#ff2a2a)}
  .stam-fill{background:linear-gradient(90deg,#7ee7ff,#00b7ff)}
  .mana-fill{background:linear-gradient(90deg,#b28bff,#6b43ff)}
  /* hotbar */
  #hotbar{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);z-index:10000}
  .hotbar-item{width:56px;height:56px;background:#222;border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid #ddd;cursor:pointer;position:relative}
  .hotbar-item img{width:36px;height:36px;user-select:none;-webkit-user-drag:none}
  .hotbar-item.selected{border-color:#39ffb6;box-shadow:0 0 12px #39ffb6}
  .hotbar-key{position:absolute;bottom:-16px;left:0;right:0;text-align:center;color:#fff;font-size:12px}
  #more-btn{width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:#fff;font-size:20px}
  /* backpack */
  #backpack{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,920px);height:min(80vh,520px);background:rgba(6,6,8,0.95);border-radius:12px;color:#fff;padding:12px;display:none;z-index:10010;border:1px solid rgba(255,255,255,0.04)}
  #backpack.open{display:block}
  .inv-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;flex:2;overflow:auto}
  .slot{height:72px;background:#101012;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
  .qty{position:absolute;right:6px;bottom:6px;font-size:12px;opacity:0.9}
  /* state upgrades */
  #upgrades{position:absolute;left:12px;bottom:14px;background:rgba(0,0,0,0.6);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);z-index:10000;color:#fff}
  #state{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:#fff;border:1px solid rgba(255,255,255,0.06);z-index:10000;width:220px}
  #preview{position:absolute;right:12px;bottom:12px;width:260px;height:150px;border-radius:10px;overflow:hidden;border:1px solid rgba(255,255,255,0.06);z-index:10000}
  #damage-flash{position:absolute;inset:0;background:rgba(255,0,0,0.12);opacity:0;pointer-events:none;transition:opacity .15s;z-index:10005}
  #prompt{position:absolute;left:50%;top:64%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;z-index:10005;display:none}
  /* small text */
  .muted{opacity:.85;font-size:13px}
</style>
</head>
<body>
<div id="ui-root">
  <div id="hud">
    <div class="label-row"><strong>Level <span id="level">1</span></strong><div>XP <span id="xp">0</span>/<span id="xpMax">100</span></div></div>
    <div style="margin-top:8px" class="label-row"><span>Health</span><span id="hpText">100/100</span></div>
    <div class="bar-wrap"><div class="bar"><div id="hpBar" class="fill hp-fill" style="width:100%"></div></div></div>

    <div class="label-row"><span>Stamina</span><span id="stamText">100/100</span></div>
    <div class="bar-wrap"><div class="bar"><div id="stamBar" class="fill stam-fill" style="width:100%"></div></div></div>

    <div class="label-row"><span>Mana</span><span id="manaText">60/60</span></div>
    <div class="bar-wrap"><div class="bar"><div id="manaBar" class="fill mana-fill" style="width:100%"></div></div></div>

    <div style="margin-top:8px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)" class="muted">
      <div style="font-weight:700">Quest</div>
      <div id="quest">Talk to the Forest Elder</div>
    </div>
  </div>
   <div id="hotbar" role="toolbar" aria-label="Hotbar">
     <div class="hotbar-item" data-item="" title="Slot 1"><div class="hotbar-key">1</div></div>
     <div class="hotbar-item" data-item="" title="Slot 2"><div class="hotbar-key">2</div></div>
     <div class="hotbar-item" data-item="" title="Slot 3"><div class="hotbar-key">3</div></div>
     <div id="more-btn" title="Open Backpack">⋯</div>
   </div>
   <div id="backpack">
     <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
       <div style="font-weight:800">Backpack</div>
       <div><button id="close-bp">Close</button></div>
     </div>
     <div style="display:flex;gap:12px;height:calc(100% - 44px)">
       <div class="inv-grid" id="inv-grid" style="flex:2"></div>
       <div style="flex:1;display:flex;flex-direction:column;gap:8px">
         <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
           <div style="font-weight:700;margin-bottom:6px">Crafting</div>
           <div id="craft-list"></div>
         </div>
         <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
           <div id="desc">Select a recipe</div>
         </div>
       </div>
     </div>
   </div>
   <div id="upgrades">
     <div style="font-weight:700;margin-bottom:6px">Upgrade States (XP)</div>
     <div style="display:flex;gap:6px">
       <button id="up-hp">+HP (50 XP)</button>
       <button id="up-stam">+Stam (30 XP)</button>
       <button id="up-mana">+Mana (30 XP)</button>
     </div>
     <div class="muted" style="margin-top:6px">XP: <span id="xp_small">0</span></div>
   </div>
   <div id="state">
     <div><strong>Equipped:</strong> <span id="equipped">None</span></div>
     <div><strong>Status:</strong> <span id="status">Idle</span></div>
     <div><strong>Hydration:</strong> <span id="hydration">100%</span></div>
     <div><strong>Food:</strong> <span id="food">100%</span></div>
     <div><strong>Enemies Nearby:</strong> <span id="enemyCount">0</span></div>
   </div>
   <div id="damage-flash"></div>
   <div id="prompt">Press E to interact</div>
</div>
<!-- A-Frame Scene -->
<a-scene renderer="antialias:true; colorManagement:true" shadow="type:pcfsoft">
   <a-assets>
     <img id="grassTex" src="https://tse3.mm.bing.net/th/id/OIP.WrLUxhdq7EjOQH7FRfHYDAHaHa?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" crossorigin="anonymous">
     <img id="skyTex" src="https://tse2.mm.bing.net/th/id/OIP.u-OIlMIpaxeWsgQ-VU_newHaE6?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" crossorigin="anonymous">
     <img id="bark" src="https://images.unsplash.com/photo-1578926375605-eaf7559b1458?q=80&w=1200&auto=format&fit=crop" crossorigin="anonymous">
   </a-assets>
   <a-entity light="type:ambient; color:#bbb; intensity:0.7"></a-entity>
   <a-entity light="type:directional; intensity:1" position="5 12 -3" rotation="-45 30 0" shadow="cast:true"></a-entity>
   <a-plane id="ground" src="#grassTex" rotation="-90 0 0" width="160" height="160" material="repeat: 40 40; roughness: 1" shadow="receive:true"></a-plane>
   <a-sky src="#skyTex"></a-sky>
   <!-- Castle -->
   <a-entity id="castle" position="0 0 -42">
     <a-box color="#444" width="20" height="12" depth="20" position="0 6 0" shadow="cast:true"></a-box>
     <a-text value="Dark Evil Castle" color="#fff" position="-4 14 -2" scale="3 3 3"></a-text>
   </a-entity>
   <!-- NPC group -->
   <a-entity id="npc-group" position="0 0 -4">
     <a-box id="npc" color="#FFD700" position="0 1 0" depth="0.6" height="2" width="1.2" class="clickable" shadow="cast:true"></a-box>
     <a-text value="Forest Elder (E to talk)" position="-1.6 2.6 0" color="#fff" align="center"></a-text>
   </a-entity>
   <!-- containers -->
   <a-entity id="trees"></a-entity>
   <a-entity id="boulders"></a-entity>
   <a-entity id="collectibles"></a-entity>
   <a-entity id="enemies"></a-entity>
   <!-- ponds -->
   <a-circle id="pond1" radius="1.2" color="#2aa3ff" position="-3 0.01 -3" rotation="-90 0 0" opacity="0.9" class="clickable"></a-circle>
   <a-circle id="pond2" radius="1.4" color="#2aa3ff" position="4 0.01 -6" rotation="-90 0 0" opacity="0.9" class="clickable"></a-circle>
   <!-- player rig -->
   <a-entity id="player" position="0 1.6 0">
     <a-entity id="cameraRig" position="0 0 0">
       <a-entity camera id="camera" look-controls wasd-controls position="0 0 0"></a-entity>
     </a-entity>
   </a-entity>
</a-scene>
<script>
 /* -------------------------
    Game State & Config
   ------------------------- */
 const state = {
   hp: 100, hpMax: 100,
   stamina: 100, staminaMax: 100,
   mana: 60, manaMax: 60,
   hydration: 100, food: 100,
   xp: 0, xpMax: 100, level: 1,
   equipped: '',
   spells: [{id:'spark',name:'Spark',charges:3,max:3,dmg:15,cost:5}],
   knownSpells: new Set(['spark']),
   quest: 'Talk to the Forest Elder',
   inventory: { stick:0, rock:0, mushroom:0, potion:0, water:0, 'wood-staff':0, 'stone-axe':0 }
 };

 const recipes = [
   {id:'stone-axe', name:'Stone Axe', need:{stick:2,rock:1}, desc:'A crafted axe for chopping and stronger melee.'},
   {id:'wood-staff', name:'Wood Staff', need:{stick:3}, desc:'Basic staff — improves spell damage.'},
   {id:'potion', name:'Healing Potion', need:{mushroom:2,water:1}, desc:'Restores 40 HP.'},
   {id:'fireball', name:'Spell: Fireball', need:{mushroom:1,stick:1}, desc:'Unlocks Fireball spell.'}
 ];

 const MAX_ENEMIES = 22;
 const enemiesRoot = document.getElementById('enemies');
 const treesRoot = document.getElementById('trees');
 const bouldersRoot = document.getElementById('boulders');
 const collRoot = document.getElementById('collectibles');

 const $ = s => document.querySelector(s);
 const hpBar = $('#hpBar'), stamBar = $('#stamBar'), manaBar = $('#manaBar');
 const hpText = $('#hpText'), stamText = $('#stamText'), manaText = $('#manaText');
 const hydrationEl = $('#hydration'), foodEl = $('#food'), enemyCountEl = $('#enemyCount');
 const xpEl = $('#xp'), xpMaxEl = $('#xpMax'), lvlEl = $('#level');
 const questEl = $('#quest'), equippedEl = $('#equipped'), statusEl = $('#status');
 const xp_small = $('#xp_small');

 function refreshUI(){
   hpBar.style.width = (state.hp/state.hpMax*100)+'%';
   stamBar.style.width = (state.stamina/state.staminaMax*100)+'%';
   manaBar.style.width = (state.mana/state.manaMax*100)+'%';
   hpText.textContent = `${Math.round(state.hp)}/${state.hpMax}`;
   stamText.textContent = `${Math.round(state.stamina)}/${state.staminaMax}`;
   manaText.textContent = `${Math.round(state.mana)}/${state.manaMax}`;
   hydrationEl.textContent = `${Math.round(state.hydration)}%`;
   foodEl.textContent = `${Math.round(state.food)}%`;
   xpEl.textContent = state.xp; xpMaxEl.textContent = state.xpMax; lvlEl.textContent = state.level;
   questEl.textContent = state.quest;
   equippedEl.textContent = state.equipped || 'None';
   statusEl.textContent = statusEl.textContent || 'Idle';
   xp_small.textContent = state.xp;
   renderInventory(); renderCrafting(); updateEnemyCount();
 }
 refreshUI();

 function statusPulse(text){
   statusEl.textContent = text;
   clearTimeout(statusPulse.timeoutId);
   statusPulse.timeoutId = setTimeout(() => statusEl.textContent = 'Idle', 2200);
 }

 /* -- Inventory, crafting, environment, enemies, combat etc. (your existing code here, unchanged) -- */

 // NPC interaction as per your snippet:
 function interactNear(){
   const playerPos = document.getElementById('player').object3D.position;
   const npcGroup = document.getElementById('npc-group');
   const np = npcGroup.object3D.position;
   if(Math.hypot(np.x - playerPos.x, np.z - playerPos.z) < 2.2){
     if(state.quest === 'Talk to the Forest Elder'){
       state.quest = 'Collect 5 sticks for the Elder';
       statusPulse('Quest started: Collect 5 sticks');
     }
     else if(state.quest === 'Collect 5 sticks for the Elder'){
       if((state.inventory.stick || 0) >= 5){
         state.inventory.stick -= 5;
         addXP(60);
         state.quest = 'Complete! Elder teaches Fireball.';
         if(!state.knownSpells.has('fireball')){
           state.knownSpells.add('fireball');
           state.spells.push({id:'fireball', name:'Fireball', charges:2, max:2, dmg:35, cost:15});
           statusPulse('Quest complete! Learned Fireball');
         }
         refreshUI();
       } else {
         statusPulse('You need 5 sticks');
       }
     } else {
       statusPulse('The Elder nods.');
     }
     refreshUI();
     return;
   }
   // Also pick up collectible items near player on 'E':
   for(const c of Array.from(collRoot.children)){
     const pos = c.object3D.position;
     if(Math.hypot(pos.x-playerPos.x,pos.z-playerPos.z) < 1.6){
       state.inventory[c.__type] = (state.inventory[c.__type]||0)+1;
       if(c.parentNode) c.parentNode.removeChild(c);
       statusPulse('Picked up ' + c.__type);
       refreshUI();
       return;
     }
   }
   // Pond water pickup
   for(const id of ['pond1','pond2']){
     const p = document.getElementById(id);
     const pos = p.object3D.position;
     if(Math.hypot(pos.x-playerPos.x,pos.z-playerPos.z) < 2){
       state.inventory.water = (state.inventory.water||0) + 1;
       statusPulse('Filled water');
       refreshUI();
       return;
     }
   }
   statusPulse('Nothing to interact');
 }
 document.addEventListener('keydown', e=>{ if(e.key.toLowerCase() === 'e') interactNear(); });

 function updatePrompt(){
   const playerPos = document.getElementById('player').object3D.position;
   let show = false;
   const npc = document.getElementById('npc-group');
   if(Math.hypot(npc.object3D.position.x - playerPos.x, npc.object3D.position.z - playerPos.z) < 2.2){
     show = true;
   }
   for(const c of Array.from(collRoot.children)){
     const pos = c.object3D.position;
     if(Math.hypot(pos.x-playerPos.x,pos.z-playerPos.z) < 1.6){
       show = true;
       break;
     }
   }
   if(!show){
     for(const id of ['pond1','pond2']){
       const p = document.getElementById(id);
       if(Math.hypot(p.object3D.position.x-playerPos.x,p.object3D.position.z-playerPos.z) < 2){
         show = true;
         break;
       }
     }
   }
   document.getElementById('prompt').style.display = show ? 'block' : 'none';
 }
 setInterval(updatePrompt, 250);

 // Enable pointer lock on click for mouse look
 const sceneEl = document.querySelector('a-scene');
 sceneEl.addEventListener('click', () => {
   if (!document.pointerLockElement) {
     sceneEl.requestPointerLock = sceneEl.requestPointerLock || sceneEl.mozRequestPointerLock || sceneEl.webkitRequestPointerLock;
     if(sceneEl.requestPointerLock) sceneEl.requestPointerLock();
   }
 });

 // Your entire other code for enemies, combat, environment, XP, damage, etc., remains unchanged.
 // (Please insert your full original code here as it is.)

 console.info('Game loaded. Controls: WASD + mouse to look. Click to attack or Space. E to interact. Click scene to lock pointer.');
</script>
</body>
</html>