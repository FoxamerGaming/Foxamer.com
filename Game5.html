<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Magic Survival</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>
<style>
  html,body{height:100%;margin:0;background:#000;font-family:system-ui,Segoe UI,Roboto,Arial}
  #ui-root{position:absolute;inset:0;z-index:9999;pointer-events:none}
  .ui-clickable, #start-btn, #more-btn, #close-bp, .hotbar-item, button { pointer-events:auto }
  #hud{position:absolute;left:12px;top:12px;color:#fff;width:360px;z-index:10000}
  .label-row{display:flex;justify-content:space-between;font-size:13px}
  .bar-wrap{margin:6px 0;background:rgba(0,0,0,0.55);padding:6px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
  .bar{height:14px;border-radius:8px;background:#222;overflow:hidden}
  .fill{height:100%;transition:width .2s}
  .hp-fill{background:linear-gradient(90deg,#ff6a6a,#ff2a2a)}
  .stam-fill{background:linear-gradient(90deg,#7ee7ff,#00b7ff)}
  .mana-fill{background:linear-gradient(90deg,#b28bff,#6b43ff)}
  #hotbar{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:10px;padding:10px;border-radius:12px;background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.06);z-index:10000}
  .hotbar-item{width:56px;height:56px;background:#222;border-radius:8px;display:flex;align-items:center;justify-content:center;border:2px solid #555;cursor:pointer;position:relative;opacity:.55}
  .hotbar-item.active{border-color:#39ffb6;box-shadow:0 0 12px #39ffb6;opacity:1}
  .hotbar-item img{width:36px;height:36px;user-select:none;-webkit-user-drag:none}
  .hotbar-key{position:absolute;bottom:-16px;left:0;right:0;text-align:center;color:#fff;font-size:12px}
  #more-btn{width:40px;height:40px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);color:#fff;font-size:20px}
  #backpack{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(92vw,920px);height:min(80vh,520px);background:rgba(6,6,8,0.95);border-radius:12px;color:#fff;padding:12px;display:none;z-index:10010;border:1px solid rgba(255,255,255,0.04)}
  #backpack.open{display:block}
  .inv-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px;flex:2;overflow:auto}
  .slot{height:72px;background:#101012;border-radius:8px;display:flex;align-items:center;justify-content:center;position:relative;border:1px solid rgba(255,255,255,0.08);cursor:pointer}
  .qty{position:absolute;right:6px;bottom:6px;font-size:12px;opacity:0.9}
  .craft-row{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed rgba(255,255,255,0.06)}
  .craft-left{display:flex;align-items:center;gap:10px}
  .craft-left img{width:28px;height:28px;border-radius:4px}
  #upgrades{position:absolute;left:12px;bottom:14px;background:rgba(0,0,0,0.6);padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.05);z-index:10000;color:#fff}
  #state{position:absolute;right:12px;top:12px;background:rgba(0,0,0,0.6);padding:10px;border-radius:10px;color:#fff;border:1px solid rgba(255,255,255,0.06);z-index:10000;width:260px}
  #damage-flash{position:absolute; inset:0;background:rgba(255,0,0,0.12);opacity:0;pointer-events:none;transition:opacity .15s;z-index:10005}
  #prompt{position:absolute;left:50%;top:64%;transform:translateX(-50%);background:rgba(0,0,0,0.6);color:#fff;padding:6px 10px;border-radius:8px;z-index:10005;display:none}
  #infobox{position:absolute;right:12px;bottom:12px;width:300px;background:rgba(0,0,0,0.6);color:#fff;border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:10px;z-index:10000;max-height:40vh;overflow:auto;font-size:13px}
  #infobox h4{margin:0 0 6px 0;font-size:14px}
  .muted{opacity:.85}
  #intro{position:absolute; inset:0;background:radial-gradient(ellipse at center, rgba(0,0,0,.75), rgba(0,0,0,.95));display:flex;align-items:center;justify-content:center;flex-direction:column;color:#fff;z-index:10050}
  #intro h1{font-size:42px;margin:0 0 8px 0;letter-spacing:1px}
  #intro p{max-width:680px;text-align:center;margin:0 0 16px 0;opacity:.9}
  #start-btn{padding:10px 18px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.1);color:#fff;font-weight:700;cursor:pointer}
  #lock-helper{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);color:#fff;background:rgba(0,0,0,.55);padding:8px 12px;border-radius:8px;font-size:14px;z-index:10006;display:none}
  #rubybar {
    position: absolute;
    right: 18px;
    top: 18px;
    background: rgba(0,0,0,0.6);
    padding: 8px 18px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 10020;
    font-size: 17px;
    font-weight: 700;
    color: #ffe5ee;
    box-shadow: 0 0 8px #d20080 inset;
  }
  .ruby-icon {
    width: 28px;
    height: 28px;
    vertical-align: middle;
    margin-right: 8px;
  }
  #daytime-bar {
    position: absolute;
    left: 50%;
    top: 8px;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.5);
    color: #ffe;
    padding: 6px 18px;
    font-size: 15px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.06);
    z-index: 10030;
    font-weight: 700;
    box-shadow: 0 0 6px #ffe inset;
  }
</style>
</head>
<body>
<div id="ui-root">
  <!-- Intro -->
  <div id="intro">
    <h1>Magic Survival</h1>
    <p>You awaken in the Emerald Vale with <b>nothing</b>. Scrounge sticks, rocks, and mushrooms, craft your first tools, then earn the Elder’s trust. Beware creatures in the wilds—most ignore you unless you strike first.</p>
    <div class="muted" style="margin-bottom:10px">Controls: WASD move · Mouse look (click to lock) · Shift sprint · E pick up · G talk/interact · Left Click attack/place · Right Click fireball · Space jump · B build · C climb</div>
    <button id="start-btn">Start Adventure</button>
  </div>
  <!-- Ruby Hotbar -->
  <div id="rubybar">
    <img src="https://cdn-icons-png.flaticon.com/128/1997/1997928.png" alt="Ruby" class="ruby-icon">
    Rubies: <span id="rubyCount">0</span>
  </div>
  <!-- Day/Night bar -->
  <div id="daytime-bar">Day</div>
  <!-- HUD, backpack, etc. (unchanged) -->
  <!-- ... rest of your UI code unchanged ... -->
  <!-- HUD -->
  <div id="hud">
    <div class="label-row"><strong>Level <span id="level">1</span></strong><div>XP <span id="xp">0</span>/<span id="xpMax">100</span></div></div>
    <div style="margin-top:8px" class="label-row"><span>Health</span><span id="hpText">100/100</span></div>
    <div class="bar-wrap"><div class="bar"><div id="hpBar" class="fill hp-fill" style="width:100%"></div></div></div>
    <div class="label-row"><span>Stamina</span><span id="stamText">100/100</span></div>
    <div class="bar-wrap"><div class="bar"><div id="stamBar" class="fill stam-fill" style="width:100%"></div></div></div>
    <div class="label-row"><span>Mana</span><span id="manaText">60/60</span></div>
    <div class="bar-wrap"><div class="bar"><div id="manaBar" class="fill mana-fill" style="width:100%"></div></div></div>
    <div style="margin-top:8px;background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
      <div style="font-weight:700">Quest</div>
      <div id="quest">Talk to the Forest Elder</div>
    </div>
  </div>
  <!-- Hotbar -->
  <div id="hotbar" role="toolbar" aria-label="Hotbar">
    <div class="hotbar-item" data-item="stone-axe" title="Stone Axe"><img id="hb2" alt=""><div class="hotbar-key">1</div></div>
    <div class="hotbar-item" data-item="wood-staff" title="Wood Staff"><img id="hb3" alt=""><div class="hotbar-key">2</div></div>
    <div id="more-btn" class="ui-clickable" title="Open Backpack">⋯</div>
  </div>
  <!-- Backpack / Crafting -->
  <div id="backpack">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="font-weight:800">Backpack</div>
      <div><button id="close-bp" class="ui-clickable">Close</button></div>
    </div>
    <div style="display:flex;gap:12px;height:calc(100% - 44px)">
      <div class="inv-grid" id="inv-grid" style="flex:2"></div>
      <div style="flex:1;display:flex;flex-direction:column;gap:8px">
        <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
          <div style="font-weight:700;margin-bottom:6px">Crafting</div>
          <div id="craft-list"></div>
        </div>
        <div style="background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)">
          <div id="desc" class="muted">Pick up materials with <b>E</b> to craft. Talk to the Elder with <b>G</b>.</div>
        </div>
      </div>
    </div>
  </div>
  <div id="upgrades">
    <div style="font-weight:700;margin-bottom:6px">Upgrade States (XP)</div>
    <div style="display:flex;gap:6px">
      <button id="up-hp" class="ui-clickable">+HP (50 XP)</button>
      <button id="up-stam" class="ui-clickable">+Stam (30 XP)</button>
      <button id="up-mana" class="ui-clickable">+Mana (30 XP)</button>
    </div>
    <div class="muted" style="margin-top:6px">XP: <span id="xp_small">0</span></div>
  </div>
  <div id="state">
    <div><strong>Equipped:</strong> <span id="equipped">None</span></div>
    <div><strong>Status:</strong> <span id="status">Idle</span></div>
    <div><strong>Hydration:</strong> <span id="hydration">100%</span></div>
    <div><strong>Food:</strong> <span id="food">100%</span></div>
    <div><strong>Enemies Nearby:</strong> <span id="enemyCount">0</span></div>
  </div>
  <div id="infobox">
    <h4>Info</h4>
    <div id="infolog" class="muted"></div>
  </div>
  <div id="damage-flash"></div>
  <div id="prompt" style="display:none;"></div>
  <div id="lock-helper">Click the scene to enable mouse look (Esc to release)</div>
</div>
<a-scene physics="gravity: -9.8" renderer="antialias:true; colorManagement:true" shadow="type:pcfsoft">
  <a-assets>
    <img id="grassTex" src="https://tse3.mm.bing.net/th/id/OIP.wjDgTaxNxEzfCY4cYNiUIwHaEJ?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" crossorigin="anonymous">
    <img id="skyTex"   src="https://tse3.mm.bing.net/th/id/OIP.6Ddp4MLFtuM7DFzkxFTG4AHaE7?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" crossorigin="anonymous">
    <img id="bark"     src="https://tse3.mm.bing.net/th/id/OIP.9-L_yT9IyyNgdNkopIT4PAHaLH?r=0&rs=1&pid=ImgDetMain&o=7&rm=3" crossorigin="anonymous">
    <img id="leaf"     src="https://as2.ftcdn.net/v2/jpg/01/65/68/07/1000_F_165680748_x7HmRDk22UU5DiB4r74mVKVf2gO5mp6a.jpg" crossorigin="anonymous">
    <img id="ruby" src="https://cdn-icons-png.flaticon.com/128/1997/1997928.png" crossorigin="anonymous">
    <img id="villagerImg" src="https://cdn-icons-png.flaticon.com/128/4140/4140048.png" crossorigin="anonymous">
  </a-assets>
  <a-entity light="type:ambient; color:#bbb; intensity:0.8" id="ambientLight"></a-entity>
  <a-entity light="type:directional; intensity:1" position="5 12 -3" rotation="-45 30 0" shadow="cast:true"></a-entity>
  <a-plane id="ground" src="#grassTex" rotation="-90 0 0" width="240" height="240"
           material="repeat: 100 100; roughness: 1" shadow="receive:true" static-body></a-plane>
  <a-sky id="sky" color="#88dffe"></a-sky>
  <!-- Castle -->
  <a-entity id="castle" position="0 0 -28">
    <a-box color="#444" width="16" height="10" depth="16" position="0 5 0" shadow="cast:true" static-body></a-box>
    <a-text value="Dark Evil Castle" color="#fff" position="-4 12 -2" scale="3 3 3"></a-text>
  </a-entity>
  <!-- Mountains ring (well outside) -->
  <a-entity id="mountains"></a-entity>
  <!-- Flora -->
  <a-entity id="trees"></a-entity>
  <a-entity id="bushes"></a-entity>
  <a-entity id="boulders"></a-entity>
  <!-- NPCs -->
  <a-entity id="npc-group" position="0 0 -6">
    <a-box id="npc" color="#FFD700" position="0 1 0" depth="0.6" height="2" width="1.2" class="clickable" shadow="cast:true" static-body></a-box>
    <a-text value="Forest Elder (G to talk)" position="-1.6 2.6 0" color="#fff" align="center"></a-text>
  </a-entity>
  <a-entity id="villager-far" position="28 0 14">
    <a-box color="#a7e0a0" position="0 1 0" depth="0.7" height="2" width="1.2" shadow="cast:true" static-body></a-box>
    <a-text value="Villager" color="#fff" position="-1.2 2.6 0" scale="2 2 2"></a-text>
  </a-entity>
  <!-- Shop house and shop villager -->
  <a-entity id="shop-house" position="20 0 17">
    <a-box width="3" depth="3" height="0.1" position="0 0 0" color="#8b5a2b"></a-box>
    <a-box width="3" depth="0.1" height="1.2" position="0 0.65 -1.45" color="#cfa07f"></a-box>
    <a-box width="3" depth="0.1" height="1.2" position="0 0.65 1.45" color="#cfa07f"></a-box>
    <a-box width="0.1" depth="3" height="1.2" position="-1.45 0.65 0" color="#cfa07f"></a-box>
    <a-box width="0.1" depth="3" height="1.2" position="1.45 0.65 0" color="#cfa07f"></a-box>
    <a-cone radius-bottom="2" radius-top="0.1" height="0.8" position="0 2.1 0" rotation="0 0 0" color="#8b1f1f"></a-cone>
    <a-entity id="shop-villager" position="0 0.25 0.7">
      <a-box color="#FFD700" position="0 1 0" depth="0.6" height="2" width="1.2"></a-box>
      <a-image src="#villagerImg" position="0 2.1 0" width="0.7" height="0.7"></a-image>
      <a-text value="Shop: G to buy/sell" color="#fff" position="-1.7 2.6 0" scale="1.6 1.6 1.6"></a-text>
    </a-entity>
  </a-entity>
  <a-entity id="collectibles"></a-entity>
  <a-entity id="enemies"></a-entity>
  <!-- Ponds -->
  <a-circle id="pond1" radius="1.2" color="#2aa3ff" position="-6 0.01 -10" rotation="-90 0 0" opacity="0.9" class="clickable" static-body></a-circle>
  <a-circle id="pond2" radius="1.4" color="#2aa3ff" position="6 0.01 -14" rotation="-90 0 0" opacity="0.9" class="clickable" static-body></a-circle>
  <!-- Player -->
  <a-entity id="player" position="0 1.6 2">
    <a-entity id="camera" camera look-controls="pointerLockEnabled: true" position="0 0 0"></a-entity>
  </a-entity>
</a-scene>
<script>
// ========== STATE & CONFIG ==========
const state = {
  hp:100, hpMax:100,
  stamina:100, staminaMax:100,
  mana:60, manaMax:60,
  hydration:100, food:100,
  xp:0, xpMax:100, level:1,
  equipped:'',
  spells:[{id:'spark',name:'Spark',charges:0,max:3,dmg:15,cost:5}],
  knownSpells:new Set(['spark']),
  quest:'Talk to the Forest Elder',
  inventory:{ stick:0, rock:0, mushroom:0, potion:0, water:0, 'wood-staff':0, 'stone-axe':0, planks:0, house:0, ruby:0, fireball:0 }
};
const shopItems = [
  {id:'food', name:'Food', price:3},
  {id:'armour', name:'Armour', price:7}
];
const CONFIG = {
  WALK_SPEED: 2.2,
  SPRINT_SPEED: 3.8,
  SPRINT_DRAIN: 12,
  STAM_REGEN: 6,
  ENEMY_WALK: 1.2,
  ENEMY_MIN_SPAWN_DIST: 14,
  TREE_CHOP_DAMAGE: 12,
  TREE_HP: 30,
  MINING_ROCK_DAMAGE: 10,
  MINING_ROCK_HP: 40,
  GRAVITY: -9.8,
  JUMP_SPEED: 5.2,
  PLAYER_GROUND_Y: 1.6,
  FIREBALL_MANA_COST: 18
};

// ========== WORLD SPAWNS ==========
function ringMountains(){
  const ring=[
    [-100,-40],[-75,-75],[-40,-105],[0,-115],[40,-105],[75,-75],[100,-40],
    [100, 40],[75, 75],[40,105],[0,115],[-40,105],[-75,75],[-100,40]
  ];
  const root=document.querySelector('#mountains');
  ring.forEach((p,i)=>{
    const [x,z]=p;
    const h=14+Math.random()*6, r=14+Math.random()*5;
    const m=document.createElement('a-cone');
    m.setAttribute('color', i%2? '#585858':'#4e4e4e');
    m.setAttribute('position', `${x} ${h/2} ${z}`);
    m.setAttribute('radius-bottom', r.toFixed(2));
    m.setAttribute('radius-top', '0.2');
    m.setAttribute('height', h.toFixed(2));
    m.setAttribute('static-body','');
    root.appendChild(m);
  });
}
function spawnTree(x,z,hp=30){
  const ent=document.createElement('a-entity'); ent.setAttribute('position',`${x} 0 ${z}`); ent.classList.add('tree'); ent.setAttribute('static-body','');
  const trunk=document.createElement('a-cylinder'); trunk.setAttribute('height','2'); trunk.setAttribute('radius','0.25'); trunk.setAttribute('color','#8B5A2B'); trunk.setAttribute('position','0 1 0'); trunk.setAttribute('material','src:#bark; roughness:1');
  const crown=document.createElement('a-entity');
  const colors=['#0b6b2e','#0f7f39','#0a5f25'];
  for(let i=0;i<6;i++){ const s=document.createElement('a-sphere'); s.setAttribute('radius',0.8+Math.random()*0.45); s.setAttribute('color',colors[i%colors.length]); s.setAttribute('material','src:#leaf; roughness:1'); s.setAttribute('position',`${(Math.random()-.5)*1.0} ${1.6+Math.random()*0.7} ${(Math.random()-.5)*1.0}`); crown.appendChild(s); }
  ent.appendChild(trunk); ent.appendChild(crown);
  ent.__data={hp};
  document.querySelector('#trees').appendChild(ent);
}
function spawnBush(x,z){
  const e=document.createElement('a-entity'); e.setAttribute('position',`${x} 0 ${z}`); e.setAttribute('static-body','');
  for(let i=0;i<6;i++){ const s=document.createElement('a-sphere'); s.setAttribute('radius',0.35+Math.random()*0.25); s.setAttribute('color',i%2?'#126b34':'#0f7f39'); s.setAttribute('material','src:#leaf; roughness:1'); s.setAttribute('position',`${(Math.random()-.5)*0.9} ${0.35+Math.random()*0.2} ${(Math.random()-.5)*0.9}`); e.appendChild(s); }
  document.querySelector('#bushes').appendChild(e);
}
function spawnBoulder(x,z){
  const e=document.createElement('a-entity'); e.setAttribute('position',`${x} 0 ${z}`); e.setAttribute('data-boulder',''); e.setAttribute('static-body','');
  const s=document.createElement('a-sphere'); s.setAttribute('radius',0.65+Math.random()*0.3); s.setAttribute('color','#7a7a7a'); s.setAttribute('position','0 0.65 0');
  e.appendChild(s); e.__data={hp:CONFIG.MINING_ROCK_HP};
  document.querySelector('#boulders').appendChild(e);
}
ringMountains();
for(let i=0;i<20;i++) spawnTree((Math.random()*80-40).toFixed(2),(Math.random()*60-30).toFixed(2));
for(let i=0;i<16;i++) spawnBush((Math.random()*80-40).toFixed(2),(Math.random()*60-30).toFixed(2));
for(let i=0;i<12;i++) spawnBoulder((Math.random()*80-40).toFixed(2),(Math.random()*60-30).toFixed(2));

// ========== DAY/NIGHT CYCLE ==========
let timeOfDay = 0; // 0-1, 0=day, 0.5=night, 1=day
function updateDayNight(){
  timeOfDay += 0.0007;
  if(timeOfDay>1) timeOfDay=0;
  // Sky color: interpolate day/night
  const dayColor = new THREE.Color("#88dffe");
  const nightColor = new THREE.Color("#181938");
  const t = Math.abs(Math.sin(timeOfDay*Math.PI));
  const lerped = dayColor.clone().lerp(nightColor, t);
  document.querySelector('#sky').setAttribute('color', '#'+lerped.getHexString());
  document.getElementById('daytime-bar').textContent = t<0.6 ? "Day" : "Night";
  document.getElementById('ambientLight').setAttribute('light', `type:ambient; color:${'#'+lerped.getHexString()}; intensity:${0.8-(t*0.5)}`);
  setTimeout(updateDayNight, 40);
}
updateDayNight();

// ========== COLLECTIBLES ==========
const collRoot=document.querySelector('#collectibles');
function getGroundYAt(x,z){
  const origin = new THREE.Vector3(x, 12, z);
  const dir = new THREE.Vector3(0, -1, 0);
  const ray = new THREE.Raycaster(origin, dir, 0, 30);
  const staticNodes = [...document.querySelectorAll('[static-body]')].map(n=>n.object3D);
  const hits = ray.intersectObjects(staticNodes, true);
  if(hits.length) return hits[0].point.y;
  return 0;
}
function spawnCollectible(type,pos){
  const halfHeights = {
    stick: 0.075, rock: 0.10, mushroom: 0.1, potion: 0.25, water: 0.4,
    'stone-axe': 0.3, 'wood-staff': 0.6, planks: 0.1
  };
  const half = halfHeights[type] || 0.18;
  const groundY = getGroundYAt(pos.x, pos.z);
  const spawnY = groundY + half + 0.002;
  const e=document.createElement('a-entity'); e.setAttribute('position',`${pos.x} ${spawnY} ${pos.z}`); e.__type=type;
  if(type==='stick') {
    e.innerHTML=`<a-box color="#7a522a" depth="0.05" height="0.15" width="0.6" position="0 0.075 0"></a-box>`;
    e.setAttribute('dynamic-body','mass:0.2;shape:box;linearDamping:0.9;angularDamping:0.9;allowSleep:true;');
  }
  else if(type==='rock') {
    e.innerHTML=`<a-sphere color="#777" radius="0.22" position="0 0.22 0"></a-sphere>`;
    e.setAttribute('dynamic-body','mass:0.6;shape:sphere;linearDamping:0.6;angularDamping:0.6;allowSleep:true;');
  }
  else if(type==='mushroom') {
    e.innerHTML=`<a-cylinder color="#cfa07f" height="0.18" radius="0.05" position="0 0.09 0"></a-cylinder><a-sphere color="#ff3154" radius="0.15" position="0 0.22 0"></a-sphere>`;
    e.setAttribute('dynamic-body','mass:0.15;shape:box;linearDamping:0.9;angularDamping:0.9;allowSleep:true;');
  }
  else if(type==='potion') {
    e.innerHTML=`<a-cylinder color="#d45e5e" height="0.5" radius="0.15" position="0 0.25 0"></a-cylinder>`;
    e.setAttribute('dynamic-body','mass:0.25;shape:box;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  else if(type==='water') {
    e.innerHTML=`<a-cylinder color="#3bb4ff" height="0.8" radius="0.2" position="0 0.4 0"></a-cylinder>`;
    e.setAttribute('dynamic-body','mass:0.3;shape:box;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  else if(type==='stone-axe') {
    e.innerHTML=`<a-box color="#888" depth="0.2" height="0.6" width="0.15" position="0 0.3 0"></a-box>`;
    e.setAttribute('dynamic-body','mass:0.4;shape:box;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  else if(type==='wood-staff') {
    e.innerHTML=`<a-cylinder color="#6c4f2a" height="1.2" radius="0.05" position="0 0.6 0"></a-cylinder>`;
    e.setAttribute('dynamic-body','mass:0.3;shape:box;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  else if(type==='planks') {
    e.innerHTML=`<a-box color="#d2a679" depth="0.03" height="0.2" width="0.8" position="0 0.1 0"></a-box>`;
    e.setAttribute('dynamic-body','mass:0.35;shape:box;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  else if(type==='ruby') {
    e.innerHTML = `<a-sphere color="#e8006f" radius="0.18" position="0 0.18 0"></a-sphere>`;
    e.setAttribute('dynamic-body', 'mass:0.2;shape:sphere;linearDamping:0.8;angularDamping:0.8;allowSleep:true;');
  }
  collRoot.appendChild(e);
}

// Seed starting pickups
function seedBasics(){
  for(let i=0;i<7;i++) spawnCollectible('stick',{x:(Math.random()*12-6),z:(Math.random()*12-6)});
  for(let i=0;i<5;i++) spawnCollectible('rock',{x:(Math.random()*12-6),z:(Math.random()*12-6)});
  for(let i=0;i<4;i++) spawnCollectible('mushroom',{x:(Math.random()*12-6),z:(Math.random()*12-6)});
}
seedBasics();

// ========== ENEMIES ==========
const enemiesRoot=document.querySelector('#enemies');
function updateEnemyCount(){ document.getElementById('enemyCount').textContent=enemiesRoot.querySelectorAll('.enemy').length; }
function createEnemy(x,z){
  const e=document.createElement('a-entity'); e.setAttribute('position',`${x} 0.5 ${z}`);
  const body=document.createElement('a-sphere'); body.setAttribute('radius','0.5'); body.setAttribute('color','#ff5c5c'); body.setAttribute('shadow','cast:true');
  const eyeL=document.createElement('a-sphere'); eyeL.setAttribute('radius','0.07'); eyeL.setAttribute('color','#fff'); eyeL.setAttribute('position','-0.15 0.12 0.45');
  const eyeR=document.createElement('a-sphere'); eyeR.setAttribute('radius','0.07'); eyeR.setAttribute('color','#fff'); eyeR.setAttribute('position','0.15 0.12 0.45');
  const pupilL=document.createElement('a-sphere'); pupilL.setAttribute('radius','0.03'); pupilL.setAttribute('color','#000'); pupilL.setAttribute('position','-0.15 0.12 0.52');
  const pupilR=document.createElement('a-sphere'); pupilR.setAttribute('radius','0.03'); pupilR.setAttribute('color','#000'); pupilR.setAttribute('position','0.15 0.12 0.52');
  const hpText=document.createElement('a-text'); hpText.setAttribute('value','HP: 60'); hpText.setAttribute('position','0 1 0'); hpText.setAttribute('align','center'); hpText.setAttribute('color','#fff'); hpText.setAttribute('scale','1.2 1.2 1.2');
  e.appendChild(body); e.appendChild(eyeL); e.appendChild(eyeR); e.appendChild(pupilL); e.appendChild(pupilR); e.appendChild(hpText);
  e.classList.add('enemy');
  e.setAttribute('kinematic-body','');
  e.__data={hp:60,alive:true,aggro:false,vx:0,vz:0,hpText:hpText,cooldown:0,dmg:5, burning:0};
  enemiesRoot.appendChild(e);
  return e;
}
function spawnEnemySafe(){
  const p=document.querySelector('#player').object3D.position;
  let x,z,tries=0, ok=false;
  while(!ok && tries<40){
    x=(Math.random()*80-40); z=(Math.random()*60-30); tries++;
    const d=Math.hypot(x-p.x,z-p.z);
    if(d>=CONFIG.ENEMY_MIN_SPAWN_DIST) ok=true;
  }
  createEnemy(x.toFixed(2), z.toFixed(2));
}
for(let i=0;i<5;i++) spawnEnemySafe(); updateEnemyCount();

// ========== UI/REFRESH ==========
function updateRubyBar(){
  document.getElementById('rubyCount').textContent = state.inventory.ruby || 0;
}
function refreshUI(){
  document.getElementById('hpBar').style.width=(state.hp/state.hpMax*100)+'%';
  document.getElementById('stamBar').style.width=(state.stamina/state.staminaMax*100)+'%';
  document.getElementById('manaBar').style.width=(state.mana/state.manaMax*100)+'%';
  document.getElementById('hpText').textContent=`${Math.round(state.hp)}/${state.hpMax}`;
  document.getElementById('stamText').textContent=`${Math.round(state.stamina)}/${state.staminaMax}`;
  document.getElementById('manaText').textContent=`${Math.round(state.mana)}/${state.manaMax}`;
  document.getElementById('hydration').textContent=`${Math.round(state.hydration)}%`;
  document.getElementById('food').textContent=`${Math.round(state.food)}%`;
  document.getElementById('xp').textContent=state.xp;
  document.getElementById('xpMax').textContent=state.xpMax;
  document.getElementById('level').textContent=state.level;
  document.getElementById('quest').textContent=state.quest;
  document.getElementById('equipped').textContent=state.equipped? (state.equipped==='wood-staff'?'Wood Staff':'Stone Axe') : 'None';
  document.getElementById('xp_small').textContent = state.xp; // Update the small XP display
  updateRubyBar();
  updateEnemyCount();
}

// ========== START BUTTON ==========
let gameStarted = false;
document.getElementById('start-btn').onclick = () => {
  document.getElementById('intro').style.display='none';
  gameStarted = true;
  refreshUI();
};

// ========== PLAYER MOVEMENT & PHYSICS ==========
const player=document.getElementById('player'), cameraEl=document.getElementById('camera');
let moveDir={f:false,b:false,l:false,r:false}, sprinting=false;
player.__speed = CONFIG.WALK_SPEED; player.__velY = 0; player.__grounded = true;
function setSpeed(){ player.__speed = sprinting? CONFIG.SPRINT_SPEED : CONFIG.WALK_SPEED; }
setSpeed();
document.addEventListener('keydown',e=>{
  if(!gameStarted) return;
  if(e.key==='Shift'){ sprinting=true; setSpeed(); }
  if(e.key==='w'||e.key==='W') moveDir.f=true;
  if(e.key==='s'||e.key==='S') moveDir.b=true;
  if(e.key==='a'||e.key==='A') moveDir.l=true;
  if(e.key==='d'||e.key==='D') moveDir.r=true;
  if(e.code==='Space' && gameStarted){
    e.preventDefault();
    if(player.__grounded){
      player.__velY = CONFIG.JUMP_SPEED;
      player.__grounded = false;
    }
  }
  // B toggles build mode (not shown for brevity)
  // C climb
  if(e.key.toLowerCase()==='c'){
    const ray = rayFromCam(1.2);
    const statics = [...document.querySelectorAll('[static-body]')].map(n=>n.object3D);
    const hits = ray.intersectObjects(statics,true);
    if(hits.length && player.__grounded){
      player.__velY = 3.8;
      player.__grounded = false;
    }
  }
});
document.addEventListener('keyup',e=>{
  if(!gameStarted) return;
  if(e.key==='Shift'){ sprinting=false; setSpeed(); }
  if(e.key==='w'||e.key==='W') moveDir.f=false;
  if(e.key==='s'||e.key==='S') moveDir.b=false;
  if(e.key==='a'||e.key==='A') moveDir.l=false;
  if(e.key==='d'||e.key==='D') moveDir.r=false;
});
let lastFrameTime = performance.now();
function movementAndPhysicsLoop(now){
  const dt = Math.min(0.05, (now - lastFrameTime) / 1000);
  lastFrameTime = now;
  if(gameStarted){
    // horizontal movement
    const yaw = cameraEl.object3D.rotation.y;
    const forward = new THREE.Vector3(-Math.sin(yaw),0,-Math.cos(yaw));
    const right   = new THREE.Vector3(-forward.z,0,forward.x);
    let dir = new THREE.Vector3();
    if(moveDir.f) dir.add(forward);
    if(moveDir.b) dir.sub(forward);
    if(moveDir.l) dir.sub(right);
    if(moveDir.r) dir.add(right);
    if(dir.lengthSq()>0){ dir.normalize().multiplyScalar(player.__speed*dt); player.object3D.position.add(dir); }
    // vertical physics
    player.__velY += CONFIG.GRAVITY * dt;
    player.object3D.position.y += player.__velY * dt;
    if(player.object3D.position.y <= CONFIG.PLAYER_GROUND_Y){
      player.object3D.position.y = CONFIG.PLAYER_GROUND_Y;
      player.__velY = 0;
      player.__grounded = true;
    } else { player.__grounded = false; }
  }
  requestAnimationFrame(movementAndPhysicsLoop);
}
requestAnimationFrame(movementAndPhysicsLoop);

// ========== RIGHT CLICK FIREBALL ==========
document.addEventListener('mousedown',e=>{
  if(!gameStarted) return;
  if(e.button === 2){ // right click
    // Fireball: need staff, spell known, and charges
    if(state.equipped === 'wood-staff' && state.knownSpells.has('fireball') && (state.inventory.fireball||0)>0 && state.mana >= CONFIG.FIREBALL_MANA_COST){
      shootFireball();
    }
  }
});

// ========== FIREBALL SPELL LOGIC ==========
function shootFireball(){
  // Use one charge, subtract mana
  state.inventory.fireball -= 1;
  state.mana -= CONFIG.FIREBALL_MANA_COST;
  refreshUI();
  // Spawn fireball visual and check hit
  const cam = cameraEl.object3D;
  const pos = new THREE.Vector3().setFromMatrixPosition(cam.matrixWorld);
  const dir = new THREE.Vector3(0,0,-1).applyQuaternion(cam.quaternion).normalize();
  const fb = document.createElement('a-sphere');
  fb.setAttribute('radius','0.23');
  fb.setAttribute('color','#ff7f1f');
  fb.setAttribute('position',`${pos.x} ${pos.y} ${pos.z}`);
  fb.setAttribute('shadow','cast:true');
  document.querySelector('a-scene').appendChild(fb);
  let t=0;
  let hit = false;
  function anim(){
    if(t>1.5 || hit){ fb.parentNode&&fb.parentNode.removeChild(fb); return; }
    t+=0.05;
    pos.add(dir.clone().multiplyScalar(0.48));
    fb.setAttribute('position',`${pos.x} ${pos.y} ${pos.z}`);
    // Hit detection: enemies
    for(const e of enemiesRoot.children){
      if(!e.__data||!e.__data.alive) continue;
      const ep = e.object3D.position;
      if(Math.hypot(ep.x-pos.x,ep.y-pos.y,ep.z-pos.z)<1.1){
        hit = true;
        e.__data.hp -= 36;
        e.__data.hpText.setAttribute('value','HP: '+Math.max(0,Math.round(e.__data.hp)));
        // Chance of burning
        if(Math.random()<0.45){
          e.__data.burning = 5; // seconds
          e.setAttribute('color','#ffb133');
        }
        if(e.__data.hp<=0 && e.__data.alive){
          e.__data.alive=false; setTimeout(()=>e.parentNode&&e.parentNode.removeChild(e),500);
          updateEnemyCount();
          spawnCollectible('ruby',{x:ep.x, z:ep.z});
        }
        break;
      }
    }
    setTimeout(anim, 50);
  }
  anim();
}

// ========== BURNING DAMAGE ==========
setInterval(()=>{
  for(const e of enemiesRoot.children){
    if(e.__data && e.__data.burning>0){
      e.__data.hp -= 2;
      e.__data.burning -= 1;
      e.__data.hpText.setAttribute('value','HP: '+Math.max(0,Math.round(e.__data.hp)));
      if(e.__data.burning<=0) e.setAttribute('color','#ff5c5c');
      if(e.__data.hp<=0 && e.__data.alive){
        e.__data.alive=false; setTimeout(()=>e.parentNode&&e.parentNode.removeChild(e),500);
        updateEnemyCount();
        spawnCollectible('ruby',{x:e.object3D.position.x, z:e.object3D.position.z});
      }
    }
  }
},1000);

// ========== SHOP & INTERACTION ==========
function interactTalk(){
  const p = player.object3D.position;
  const elder = document.querySelector('#npc-group').object3D.position;
  const villager = document.querySelector('#villager-far').object3D.position;
  const shopHouse = document.querySelector('#shop-house').object3D.position;
  // Forest Elder
  if(Math.hypot(elder.x-p.x,elder.z-p.z)<2.2){
    if(state.quest==='Talk to the Forest Elder'){
      state.quest='Collect 5 sticks for the Elder';
    }else if(state.quest==='Collect 5 sticks for the Elder'){
      if((state.inventory.stick||0)>=5){
        state.inventory.stick-=5; state.quest='Complete! Elder teaches Fireball.';
        if(!state.knownSpells.has('fireball')){
          state.knownSpells.add('fireball'); state.spells.push({id:'fireball',name:'Fireball',charges:2,max:2,dmg:36,cost:CONFIG.FIREBALL_MANA_COST});
          state.inventory.fireball += 2;
        }
      }
    }
    refreshUI(); return true;
  }
  // Far Villager
  if(Math.hypot(villager.x-p.x, villager.z-p.z)<2.2){
    showPrompt('Villager: "Lovely day! Stay safe out there."'); return true;
  }
  // Shopkeeper
  if(Math.abs(p.x-shopHouse.x)<2 && Math.abs(p.z-shopHouse.z)<2){ interactShop(); return true; }
  showPrompt('No one to talk to'); return false;
}
function interactPickup(){
  const p=player.object3D.position;
  let nearest=null, nd=9e9;
  [...collRoot.children].forEach(c=>{
    const cp=c.object3D.position; const d=Math.hypot(cp.x-p.x, cp.z-p.z);
    if(d<1.6 && d<nd){ nd=d; nearest=c; }
  });
  if(nearest){
    const t=nearest.__type;
    if(t === 'ruby') {
      state.inventory.ruby = (state.inventory.ruby||0)+1;
      nearest.parentNode&&nearest.parentNode.removeChild(nearest);
      refreshUI();
      return true;
    }
    state.inventory[t]=(state.inventory[t]||0)+1;
    nearest.parentNode&&nearest.parentNode.removeChild(nearest);
    refreshUI(); return true;
  }
  for(const id of ['pond1','pond2']){
    const po=document.getElementById(id).object3D.position; const d=Math.hypot(po.x-p.x, po.z-p.z);
    if(d<2){ state.inventory.water=(state.inventory.water||0)+1; refreshUI(); return true; }
  }
  return false;
}
function interactShop(){
  const p = player.object3D.position;
  const shopPos = {x: 20, y: 0, z: 17};
  if(Math.abs(p.x-shopPos.x)<2 && Math.abs(p.z-shopPos.z)<2){
    let msg = 'Shop - Buy with Rubies:<br>';
    shopItems.forEach(item=>{
      msg += `${item.name} (${item.price} rubies) <button onclick="window.buyShopItem('${item.id}')">Buy</button><br>`;
    });
    msg += '<br><button onclick="window.openSellMenu()">Sell Items</button>';
    showPrompt(msg);
    return true;
  }
  showPrompt('No shop nearby');
  return false;
}
window.buyShopItem = function(id){
  const item = shopItems.find(i=>i.id===id);
  if(!item) return;
  if((state.inventory.ruby||0) < item.price){
    showPrompt('Not enough rubies!'); return;
  }
  state.inventory.ruby -= item.price;
  if(id === 'food') state.food = Math.min(100, state.food + 50);
  if(id === 'armour') { state.hpMax += 20; state.hp = state.hpMax; }
  showPrompt('Thanks for your purchase!'); refreshUI();
};
window.openSellMenu = function(){
  let msg = 'Sell Items for Rubies:<br>';
  Object.keys(state.inventory).forEach(k=>{
    if(state.inventory[k]>0 && k!=='ruby'){
      msg += `${k} x${state.inventory[k]} <button onclick="window.sellItem('${k}')">Sell</button><br>`;
    }
  });
  if(msg==='Sell Items for Rubies:<br>') msg += 'No items to sell!';
  showPrompt(msg);
};
window.sellItem = function(id){
  if(!state.inventory[id]||id==='ruby') return;
  state.inventory[id]--;
  state.inventory.ruby = (state.inventory.ruby||0)+1;
  showPrompt('Sold '+id+' for 1 ruby');
  window.openSellMenu();
  refreshUI();
};
function showPrompt(html){
  const p = document.getElementById('prompt');
  p.innerHTML = html;
  p.style.display = 'block';
  setTimeout(()=>{p.style.display='none';}, 2600);
}
document.addEventListener('keydown',e=>{
  if(!gameStarted) return;
  if(e.key.toLowerCase()==='e') interactPickup();
  if(e.key.toLowerCase()==='g') interactTalk();
});

// ========== UPGRADE STATS LOGIC ==========
function upgradeStat(statName, cost) {
  if (state.xp >= cost) {
    state.xp -= cost;
    if (statName === 'hp') {
      state.hpMax += 10;
      state.hp = state.hpMax; // Restore to full health
    } else if (statName === 'stamina') {
      state.staminaMax += 5;
      state.stamina = state.staminaMax; // Restore to full stamina
    } else if (statName === 'mana') {
      state.manaMax += 8;
      state.mana = state.manaMax; // Restore to full mana
    }
    refreshUI(); // Update the UI to reflect changes
  } else {
    showPrompt("Not enough XP to upgrade!"); // Provide feedback to the player
  }
}

// Add event listeners to the upgrade buttons
document.getElementById('up-hp').addEventListener('click', () => upgradeStat('hp', 50));
document.getElementById('up-stam').addEventListener('click', () => upgradeStat('stamina', 30));
document.getElementById('up-mana').addEventListener('click', () => upgradeStat('mana', 30));


// ========== MISC ==========
refreshUI();
</script>
</body>
</html>
